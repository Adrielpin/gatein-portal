<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "../../Reference_Guide.ent">
%BOOK_ENTITIES;
]>
<section id="sect-Reference_Guide-PicketLink_IDM_integration">
	<title>PicketLink IDM integration</title>
	<para>
		&PRODUCT; uses the PicketLink IDM component to retain necessary identity information (user, groups, memberships, etc.). While legacy interfaces are still used (org.exoplatform.services.organization) for identity management, the wrapper implementation delegates to the PicketLink IDM framework.
	</para>
	<para>
		This section doesn't provide information about PicketLink IDM and its configuration. Please refer to the appropriate project documentation (<ulink url="http://jboss.org/picketlink/IDM.html" />) for further information.
	</para>
	<note>
		<para>
			It is important to fully understand the concepts behind this framework design before changing the default configuration.
		</para>
	</note>
	<para>
		The identity model represented in '<emphasis role="bold">org.exoplatform.services.organization</emphasis>' interfaces and the one used in <emphasis role="bold">JBoss Identity IDM</emphasis> have some major differences.
	</para>	
	<para>
		For example: the <emphasis role="bold">JBoss Identity IDM</emphasis> provides greater abstraction. It is possible for groups in the <emphasis role="bold">IDM</emphasis> framework to form memberships with many parents (which requires recursive ID translation) while the GateIn model allows only pure tree like membership structures.
	</para>
	<para>
		Additionally the GateIn <emphasis>membership</emphasis> concept needs to be translated into the IDM <emphasis>Role</emphasis> concept. Therefore <emphasis role="bold">JBoss Identity IDM</emphasis> model is used in a limited way. All these translations are applied by the integration layer.
	</para>
	<section id="sect-Reference_Guide-PicketLink_IDM_integration-Configuration_files">
		<title>Configuration files</title>
		<para>
			The main configuration file is <emphasis role="bold">idm-configuration</emphasis>:
		</para>
		<programlistingco>
			<areaspec>
				<area coords="7" id="area-Reference_Guide--PicketLink_IDM_integration-Configuration_files-JBossIDMServiceImpl" />
				<area coords="52" id="area-Reference_Guide--PicketLink_IDM_integration-Configuration_files-JBossIDMOrganizationServiceImpl" />
			</areaspec>

<programlisting role="XML">&lt;configuration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xsi:schemaLocation="http://www.exoplaform.org/xml/ns/kernel_1_0.xsd http://www.exoplaform.org/xml/ns/kernel_1_0.xsd"
               xmlns="http://www.exoplaform.org/xml/ns/kernel_1_0.xsd"&gt;

   &lt;component&gt;
      &lt;key&gt;org.exoplatform.services.organization.jbidm.JBossIDMService&lt;/key&gt;
      &lt;type&gt;org.exoplatform.services.organization.jbidm.JBossIDMServiceImpl&lt;/type&gt;
      &lt;init-params&gt;
         &lt;value-param&gt;
            &lt;name&gt;config&lt;/name&gt;
            &lt;value&gt;war:/conf/organization/idm-config.xml&lt;/value&gt;
         &lt;/value-param&gt;
         &lt;values-param&gt;
            &lt;name&gt;hibernate.annotations&lt;/name&gt;
            &lt;value&gt;org.jboss.identity.idm.impl.model.hibernate.HibernateIdentityObject&lt;/value&gt;
            &lt;value&gt;org.jboss.identity.idm.impl.model.hibernate.HibernateIdentityObjectAttribute&lt;/value&gt;
            &lt;value&gt;org.jboss.identity.idm.impl.model.hibernate.HibernateIdentityObjectBinaryAttribute&lt;/value&gt;
            &lt;value&gt;org.jboss.identity.idm.impl.model.hibernate.HibernateIdentityObjectBinaryAttributeValue&lt;/value&gt;
            &lt;value&gt;org.jboss.identity.idm.impl.model.hibernate.HibernateIdentityObjectCredential&lt;/value&gt;
            &lt;value&gt;org.jboss.identity.idm.impl.model.hibernate.HibernateIdentityObjectCredentialType&lt;/value&gt;
            &lt;value&gt;org.jboss.identity.idm.impl.model.hibernate.HibernateIdentityObjectRelationship&lt;/value&gt;
            &lt;value&gt;org.jboss.identity.idm.impl.model.hibernate.HibernateIdentityObjectRelationshipName&lt;/value&gt;
            &lt;value&gt;org.jboss.identity.idm.impl.model.hibernate.HibernateIdentityObjectRelationshipType&lt;/value&gt;
            &lt;value&gt;org.jboss.identity.idm.impl.model.hibernate.HibernateIdentityObjectTextAttribute&lt;/value&gt;
            &lt;value&gt;org.jboss.identity.idm.impl.model.hibernate.HibernateIdentityObjectType&lt;/value&gt;
            &lt;value&gt;org.jboss.identity.idm.impl.model.hibernate.HibernateRealm&lt;/value&gt;
         &lt;/values-param&gt;
         &lt;properties-param&gt;
            &lt;name&gt;hibernate.properties&lt;/name&gt;
            &lt;property name="hibernate.hbm2ddl.auto" value="update"/&gt;
            &lt;property name="hibernate.current_session_context_class" value="thread"/&gt;
            &lt;property name="hibernate.show_sql" value="false"/&gt;
            &lt;property name="hibernate.cglib.use_reflection_optimizer" value="true"/&gt;
            &lt;property name="hibernate.connection.url" value="jdbc:hsqldb:file:../temp/data/exodb${container.name.suffix}"/&gt;
            &lt;property name="hibernate.connection.driver_class" value="org.hsqldb.jdbcDriver"/&gt;
            &lt;property name="hibernate.connection.autocommit" value="true"/&gt;
            &lt;property name="hibernate.connection.username" value="sa"/&gt;
            &lt;property name="hibernate.connection.password" value=""/&gt;
            &lt;property name="hibernate.dialect" value="org.hibernate.dialect.HSQLDialect"/&gt;
            &lt;property name="hibernate.c3p0.min_size" value="5"/&gt;
            &lt;property name="hibernate.c3p0.max_size" value="20"/&gt;
            &lt;property name="hibernate.c3p0.timeout" value="1800"/&gt;
            &lt;property name="hibernate.c3p0.max_statements" value="50"/&gt;
            &lt;property name="hibernate.connection.provider_class" value="org.hibernate.connection.C3P0ConnectionProvider" /&gt;
         &lt;/properties-param&gt;

      &lt;/init-params&gt;
   &lt;/component&gt;

   &lt;component&gt;
      &lt;key&gt;org.exoplatform.services.organization.OrganizationService&lt;/key&gt;
      &lt;type&gt;org.exoplatform.services.organization.jbidm.JBossIDMOrganizationServiceImpl&lt;/type&gt;
   &lt;/component&gt;

&lt;/configuration&gt;
</programlisting>
			<calloutlist>
				<callout arearefs="area-Reference_Guide--PicketLink_IDM_integration-Configuration_files-JBossIDMServiceImpl">
					<para>
						The <emphasis role="bold">org.exoplatform.services.organization.jbidm.JBossIDMServiceImpl</emphasis> service has following options:
					</para>


<!-- Included in calloutlist <para>
			The <emphasis role="bold">org.exoplatform.services.organization.jbidm.JBossIDMOrganizationServiceImpl</emphasis> is a main entrypoint implementing <emphasis role="bold">org.exoplatform.services.organization.OrganizationService</emphasis> and is dependant on <emphasis role="bold">org.exoplatform.services.organization.jbidm.JBossIDMService</emphasis>
		</para> 
		<para>
			The <emphasis role="bold">org.exoplatform.services.organization.jbidm.JBossIDMServiceImpl</emphasis> service has following options:
		</para> -->
					<itemizedlist>
						<listitem>
							<para>
								<emphasis role="bold">hibernate.properties</emphasis> - (properties-para) - a list of hibernate properties used to create SessionFactory that will be injected to JBoss Identity IDM configuration registry
							</para>
						</listitem>
						<listitem>
							<para>
								<emphasis role="bold">hibernate.annotations</emphasis> - (values-param) - list of annotated classes that will be added to hibernate configuration
							</para>
						</listitem>
						<listitem>
							<para>
								<emphasis role="bold">hibernate.mappings</emphasis> - (values-param) - list of xml files that will be added to hibernate configuration as mapping files
							</para>
						</listitem>
						<listitem>
							<para>
								<emphasis role="bold">config</emphasis> - (value-param) - JBoss Identity IDM configuration file
							</para>
						</listitem>
						<listitem>
							<para>
								<emphasis role="bold">jndiName</emphasis> - (value-param) - in case 'config' parameter is not provided this will be used to perform JNDI lookup for IdentitySessionFactory
							</para>
						</listitem>
						<listitem>
							<para>
								<emphasis role="bold">PortalRealm</emphasis> - (value-param) - name of a realm that should be used to obtain proper IdentitySession - default is 'PortalRealm'.
							</para>
						</listitem>
					</itemizedlist>
				</callout>
				<callout arearefs="area-Reference_Guide--PicketLink_IDM_integration-Configuration_files-JBossIDMOrganizationServiceImpl">
					<para>
						The <emphasis role="bold">org.exoplatform.services.organization.jbidm.JBossIDMOrganizationServiceImpl</emphasis> key is a main entrypoint implementing <emphasis role="bold">org.exoplatform.services.organization.OrganizationService</emphasis> and is dependant on <emphasis role="bold">org.exoplatform.services.organization.jbidm.JBossIDMService</emphasis>
					</para>
					<para>
						<emphasis role="bold">org.exoplatform.services.organization.jbidm.JBossIDMOrganizationServiceImpl</emphasis> service has following options:
					</para>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis role="bold">exoGroupTypeName</emphasis> - (value-param) - Name of JBoss Identity IDM GroupType that will be used to store groups. Default is 'EXO_GROUP_TYPE'
							</para>
						</listitem>
						<listitem>
							<para>
								<emphasis role="bold">exoRootGroupName</emphasis> - (value-param) - Name of JBoss Identity IDM Group that will be used as a root parent. Default is 'EXO_ROOT_GROUP'
							</para>
						</listitem>
						<listitem>
							<para>
								<emphasis role="bold">exoRootGroupTypeName</emphasis> - (value-param) - Name of JBoss Identity IDM GroupType of a Group used as a parent root. Default is 'EXO_GROUP_TYPE'
							</para>
						</listitem>
						<listitem>
							<para>
								<emphasis role="bold">passwordAsAttribute</emphasis> - (value-param) - (default false) - Specifies if password should be stored using JBoss Identity IDM Credential object or as a plain attribute
							</para>
						</listitem>
					</itemizedlist>
					<para>
						Additionally <emphasis role="bold">JBossIDMOrganizationServiceImpl</emphasis> uses those defaults to perform identity management operations
					</para>
					<itemizedlist>
						<listitem>
							<para>
								GateIn User interface properties fields are persisted in JBoss Identity IDM using those attributes names: firstName, lastName, email, createdDate, lastLoginTime, organizationId, password (if password is configured to be stored as attribute)
							</para>
						</listitem>
						<listitem>
							<para>
								GateIn Group interface properties fields are persisted in JBoss Identity IDM using those attributes names: label, description
							</para>
						</listitem>
						<listitem>
							<para>
								GateIn MembershipType interface properties fields are persisted in JBoss Identity IDM using those RoleType properties: description, owner, create_date, modified_date
							</para>
						</listitem>
					</itemizedlist>
				</callout>
			</calloutlist>
	</programlistingco>

<!--	In calloutlist above	<para>
			<emphasis role="bold">org.exoplatform.services.organization.jbidm.JBossIDMOrganizationServiceImpl</emphasis> service has following options:
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<emphasis role="bold">exoGroupTypeName</emphasis> - (value-param) - Name of JBoss Identity IDM GroupType that will be used to store groups. Default is 'EXO_GROUP_TYPE'
				</para>
			</listitem>
			<listitem>
				<para>
					<emphasis role="bold">exoRootGroupName</emphasis> - (value-param) - Name of JBoss Identity IDM Group that will be used as a root parent. Default is 'EXO_ROOT_GROUP'
				</para>
			</listitem>
			<listitem>
				<para>
					<emphasis role="bold">exoRootGroupTypeName</emphasis> - (value-param) - Name of JBoss Identity IDM GroupType of a Group used as a parent root. Default is 'EXO_GROUP_TYPE'
				</para>
			</listitem>
			<listitem>
				<para>
					<emphasis role="bold">passwordAsAttribute</emphasis> - (value-param) - (default false) - Specifies if password should be stored using JBoss Identity IDM Credential object or as a plain attribute
				</para>
			</listitem>
		</itemizedlist>
		<para>
			Additionally <emphasis role="bold">JBossIDMOrganizationServiceImpl</emphasis> uses those defaults to perform identity management operations
		</para>
		<itemizedlist>
			<listitem>
				<para>
					GateIn User interface properties fields are persisted in JBoss Identity IDM using those attributes names: firstName, lastName, email, createdDate, lastLoginTime, organizationId, password (if password is configured to be stored as attribute)
				</para>
			</listitem>
			<listitem>
				<para>
					GateIn Group interface properties fields are persisted in JBoss Identity IDM using those attributes names: label, description
				</para>
			</listitem>
			<listitem>
				<para>
					GateIn MembershipType interface properties fields are persisted in JBoss Identity IDM using those RoleType properties: description, owner, create_date, modified_date
				</para>
			</listitem>
		</itemizedlist> -->

		<para>
			A sample <emphasis role="bold">JBoss Identity IDM</emphasis> configuration file is shown below. To understand all the options present in it please refer to the JBoss Identity IDM Reference Guide
		</para>
		
<programlisting>&lt;jboss-identity xmlns="urn:jboss:identity:idm:config:v1_0_beta"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="urn:jboss:identity:idm:config:v1_0_alpha identity-config.xsd"&gt;
    &lt;realms&gt;
        &lt;realm&gt;
            &lt;id&gt;PortalRealm&lt;/id&gt;
            &lt;repository-id-ref&gt;PortalRepository&lt;/repository-id-ref&gt;
            &lt;identity-type-mappings&gt;
                &lt;user-mapping&gt;USER&lt;/user-mapping&gt;
            &lt;/identity-type-mappings&gt;
        &lt;/realm&gt;
    &lt;/realms&gt;
    &lt;repositories&gt;
        &lt;repository&gt;
            &lt;id&gt;PortalRepository&lt;/id&gt;
            &lt;class&gt;org.jboss.identity.idm.impl.repository.WrapperIdentityStoreRepository&lt;/class&gt;
            &lt;external-config/&gt;
            &lt;default-identity-store-id&gt;HibernateStore&lt;/default-identity-store-id&gt;
            &lt;default-attribute-store-id&gt;HibernateStore&lt;/default-attribute-store-id&gt;
        &lt;/repository&gt;
    &lt;/repositories&gt;
    &lt;stores&gt;
        &lt;attribute-stores/&gt;
        &lt;identity-stores&gt;
            &lt;identity-store&gt;
                &lt;id&gt;HibernateStore&lt;/id&gt;
                &lt;class&gt;org.jboss.identity.idm.impl.store.hibernate.HibernateIdentityStoreImpl&lt;/class&gt;
                &lt;external-config/&gt;
                &lt;supported-relationship-types&gt;
                    &lt;relationship-type&gt;JBOSS_IDENTITY_MEMBERSHIP&lt;/relationship-type&gt;
                    &lt;relationship-type&gt;JBOSS_IDENTITY_ROLE&lt;/relationship-type&gt;
                &lt;/supported-relationship-types&gt;
                &lt;supported-identity-object-types&gt;
                    &lt;identity-object-type&gt;
                        &lt;name&gt;USER&lt;/name&gt;
                        &lt;relationships/&gt;
                        &lt;credentials&gt;
                            &lt;credential-type&gt;PASSWORD&lt;/credential-type&gt;
                        &lt;/credentials&gt;
                        &lt;attributes/&gt;
                        &lt;options/&gt;
                    &lt;/identity-object-type&gt;
                &lt;/supported-identity-object-types&gt;
                &lt;options&gt;
                    &lt;option&gt;
                        &lt;name&gt;hibernateSessionFactoryRegistryName&lt;/name&gt;
                        &lt;value&gt;hibernateSessionFactory&lt;/value&gt;
                    &lt;/option&gt;
                    &lt;option&gt;
                        &lt;name&gt;allowNotDefinedIdentityObjectTypes&lt;/name&gt;
                        &lt;value&gt;true&lt;/value&gt;
                    &lt;/option&gt;
                    &lt;option&gt;
                        &lt;name&gt;populateRelationshipTypes&lt;/name&gt;
                        &lt;value&gt;true&lt;/value&gt;
                    &lt;/option&gt;
                    &lt;option&gt;
                        &lt;name&gt;populateIdentityObjectTypes&lt;/name&gt;
                        &lt;value&gt;true&lt;/value&gt;
                    &lt;/option&gt;
                    &lt;option&gt;
                        &lt;name&gt;allowNotDefinedAttributes&lt;/name&gt;
                        &lt;value&gt;true&lt;/value&gt;
                    &lt;/option&gt;
                    &lt;option&gt;
                        &lt;name&gt;isRealmAware&lt;/name&gt;
                        &lt;value&gt;true&lt;/value&gt;
                    &lt;/option&gt;
                &lt;/options&gt;
            &lt;/identity-store&gt;
        &lt;/identity-stores&gt;
    &lt;/stores&gt;
&lt;/jboss-identity&gt;
</programlisting>
	</section>

</section>


