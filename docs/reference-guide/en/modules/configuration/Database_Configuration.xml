<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "../../Reference_Guide.ent">
%BOOK_ENTITIES;
<!ENTITY % BOOK_ENTITIES SYSTEM "../../Reference_Guide.ent">
%BOOK_ENTITIES;
]>
<section id="sect-Reference_Guide-Database_Configuration">
  <title>Database Configuration</title>

  <section id="sect-Reference_Guide-Database_Configuration-Overview">
    <title>Overview</title>

    <para>&PRODUCT; has two different database dependencies. One is the
    identity service configuration, which depends on the Hibernate. The other
    database dependency is Java content repository (JCR) service, which
    depends on the native JDBC API and it can integrate with any existing
    datasource implementation.</para>

    <para>When you change the database configuration for the first time,
    GateIn will automatically generate the proper schema (assuming that the
    database user has the appropriate permissions).</para>

    <para>GateIn assumes the default encoding for your database is
    <literal>latin1</literal> . You will need to change this parameter for
    your database in order to work properly.</para>
  </section>

  <section id="sect-Reference_Guide-Database_Configuration-JCR_database_configuration">
    <title>Configuring the database for JCR</title>

    <para>To configure the databaseused by JCR you will need to edit the
    file:<programlisting>gatein.ear/02portal.war/WEB-INF/conf/jcr/jcr-configuration.xml</programlisting></para>

    <para>And edit the values of driverClassName, url, username and password
    with the values for your JDBC connection (Please refer to your database
    JDBC driver documentation).</para>

    <programlisting role="XML">&lt;properties-param&gt;
  &lt;name&gt;ref-addresses&lt;/name&gt;
  &lt;description&gt;ref-addresses&lt;/description&gt;
  &lt;property name="driverClassName" value="org.hsqldb.jdbcDriver"/&gt;
  &lt;property name="url" value="jdbc:hsqldb:file:${gatein.db.data.dir}/data/jdbcjcr${container.name.suffix}"/&gt;
  property name="username" value="sa"/&gt;
  &lt;property name="password" value=""/&gt;
&lt;/properties-param&gt;
</programlisting>

    <para>In that case, the name of the database is
    "jdbcjcr${container.name.suffix}", ${container.name.suffix} should be part
    of the database name, as it is dynamically replaced by the name of the
    portal extension (for instance gatein-sample-portal.ear defines
    "sample-portal" as container name and the default portal defines "portal"
    as container name). </para>

    <para>In the case of HSQL the databases are created automatically, for any
    other database you will need to create a database named jdbcjcr_portal
    (and "jdbcjcr_sample-portal" if you kept gatein-sample-portal.ear in
    $JBOSS_HOME/server/default/deploy. Note that some database wont accept '-'
    in a database name and you will have to delete
    $JBOSS_HOME/server/default/deploy/gatein-sample-portal.ear)</para>

    <para>Make sure the user has rights to create tables on jdbcjcr_portal and
    to update them as during the first startup they will be automatically
    created.</para>

    <para>Also add the JDBC driver into the classpath, for instance in
    $JBOSS_HOME/server/default/lib (or $TOMCAT_HOME/lib if you are running on
    Tomcat)</para>

    <para>MySQL example:</para>

    <para>Let's configure our JCR to store data in MySQL, let's pretend we
    have a user named "gateinuser" with a password "gateinpassword". We would
    create a database "mygateindb_portal" (Remember that _portal is required)
    and assign him the rights to create tables.</para>

    <para>Then we need to add the MySQL JDBC connector in the classpath and
    finally edit gatein.ear/02portal.war/WEB-INF/conf/jcr/jcr-configuration
    with:<programlisting>&lt;properties-param&gt;
  &lt;name&gt;ref-addresses&lt;/name&gt;
  &lt;description&gt;ref-addresses&lt;/description&gt;
  &lt;property name="driverClassName" value="com.mysql.jdbc.Driver"/&gt;
  &lt;property name="url" value="jdbc:mysql://localhost:3306/mygateindb${container.name.suffix}"/&gt;
  &lt;property name="username" value="gateinuser"/&gt;
  &lt;property name="password" value="gateinpassword"/&gt;
&lt;/properties-param&gt;</programlisting></para>
  </section>

  <section>
    <title>Configuring the database for the default identity store</title>

    <para>By default users are stored in database. To change the database to
    store users, you will need to edit the file:</para>

    <para><programlisting>gatein.ear/02portal.war/WEB-INF/conf/organization/idm-configuration.xml</programlisting>You
    will find the same configuration as in
    jcr-configuration.xml:<programlisting>&lt;properties-param&gt;
  &lt;name&gt;ref-addresses&lt;/name&gt;
  &lt;description&gt;ref-addresses&lt;/description&gt;
  &lt;property name="driverClassName" value="org.hsqldb.jdbcDriver"/&gt;
  &lt;property name="url" value="jdbc:hsqldb:file:${gatein.db.data.dir}/data/jdbcidm${container.name.suffix}"/&gt;
  property name="username" value="sa"/&gt;
  &lt;property name="password" value=""/&gt;
&lt;/properties-param&gt;</programlisting></para>

    <para>It is recommended to use a different database than the one used by
    JCR.</para>
  </section>
</section>
